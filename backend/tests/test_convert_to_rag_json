from __future__ import annotations

import json
from pathlib import Path

import convert_to_rag_json as c


def test__sanitize_text_removes_control_chars_and_normalizes_newlines() -> None:
    raw = "hello\x00world\r\nnext"
    out = c._sanitize_text(raw)
    assert "\x00" not in out
    assert "\r" not in out
    assert "hello" in out and "world" in out
    assert "\n" in out


def test_parse_transcript_lines_single_line_quote_and_infer_speaker() -> None:
    q1, q2 = c.QUOTE_OPEN, c.QUOTE_CLOSE
    lines = [
        "Episode: EP1\n",
        f"Amuro {q1}行きます{q2}\n",
        f"{q1}次のセリフ{q2}\n",  # speaker omitted -> inferred from last_speaker
    ]
    parsed = c.parse_transcript_lines(lines)

    # (line_no, speaker, quote, speaker_inferred, episode_title)
    assert parsed[0][0] == 2
    assert parsed[0][1] == "Amuro"
    assert parsed[0][2] == "行きます"
    assert parsed[0][3] is False
    assert parsed[0][4] == "EP1"

    assert parsed[1][0] == 3
    assert parsed[1][1] == "Amuro"
    assert parsed[1][2] == "次のセリフ"
    assert parsed[1][3] is True
    assert parsed[1][4] == "EP1"


def test_parse_transcript_lines_multiline_quote() -> None:
    q1, q2 = c.QUOTE_OPEN, c.QUOTE_CLOSE
    lines = [
        "Episode: EP2\n",
        f"Char {q1}赤い彗星は\n",
        f"二度刺す{q2}\n",
    ]
    parsed = c.parse_transcript_lines(lines)
    assert len(parsed) == 1
    _, speaker, quote, inferred, ep = parsed[0]
    assert speaker == "Char"
    assert quote == "赤い彗星は\n二度刺す"
    assert inferred is False
    assert ep == "EP2"


def test_build_rag_records_and_write_json(tmp_path: Path) -> None:
    parsed = [
        (10, "Amuro", "hello", False, "EP1"),
        (11, "Amuro", "world", True, "EP1"),
    ]
    records = c.build_rag_records(
        parsed=parsed,
        base_id="gundam",
        source="local",
        tags=["miura", ""],
        lang="ja",
    )
    assert len(records) == 2
    assert records[0].id.startswith("gundam:")
    assert records[0].source == "local"
    assert records[0].metadata["speaker"] == "Amuro"
    assert records[1].metadata["speaker_inferred"] is True
    assert records[0].metadata["tags"] == "miura"

    out = tmp_path / "out.json"
    c.write_json(records, str(out), jsonl=False)
    data = json.loads(out.read_text(encoding="utf-8"))
    assert isinstance(data, list) and len(data) == 2
    assert data[0]["id"] == records[0].id

    outl = tmp_path / "out.jsonl"
    c.write_json(records, str(outl), jsonl=True)
    lines = outl.read_text(encoding="utf-8").splitlines()
    assert len(lines) == 2
    assert json.loads(lines[0])["id"] == records[0].id
